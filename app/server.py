import aiohttp
import asyncio
import uvicorn
from fastai import *
from fastai.vision import *
from io import BytesIO
from starlette.applications import Starlette
from starlette.middleware.cors import CORSMiddleware
from starlette.responses import HTMLResponse, JSONResponse
from starlette.staticfiles import StaticFiles

# 3 plants
# export_file_url = 'https://www.dropbox.com/s/avqg2vtxdwer20f/3plants.pkl?raw=1'
# export_file_name = '3plants.pkl'

# conifere
export_file_url = 'https://www.dropbox.com/s/5bbxdv99g9izy03/conifere.pkl?raw=1'
export_file_name = 'conifere.pkl'


classes = [u'Cedrus deodara', u'Cedrus atlantica', u'Cedrus libani', u'Cathaya argyrophylla', u'Sundacarpus amarus', u'Stachycarpus ferruginea', u'Prumnopitys andina', u'Retrophyllum comptonii', u'Prumnopitys ferruginea', u'Prumnopitys harmsiana', u'Retrophyllum vitiense', u'Prumnopitys standleyi', u'Podocarpus aracensis', u'Podocarpus angustifolius', u'Podocarpus andina', u'Podocarpus alba', u'Retrophyllum piresii', u'Phyllocladus serratifolia', u'Phyllocladus serratifolia', u'Phyllocladus hypophyllus', u'Podocarpus acutifolius', u'Retrophyllum minus', u'Prumnopitys ferruginoides', u'Prumnopitys ladei', u'Prumnopitys exigua', u'Prumnopitys taxifolia', u'Prumnopitys montana', u'Podocarpus brevifolius', u'Podocarpus brownii', u'Podocarpus brassii', u'Podocarpus bracteatus', u'Podocarpus barretoi', u'Podocarpus ballivianensis', u'Podocarpus atjehensis', u'Podocarpus archboldii', u'Phyllocladus trichomanoides', u'Podocarpus confertus', u'Podocarpus colombianus', u'Podocarpus chinensis', u'Podocarpus celatus', u'Podocarpus buchholzii', u'Podocarpus borneensis', u'Podocarpus drouynianus', u'Podocarpus dispermus', u'Podocarpus dieffenbachii', u'Podocarpus degeneri', u'Podocarpus decumbens', u'Podocarpus cupressina', u'Podocarpus cunninghamii', u'Podocarpus crassifolius', u'Podocarpus costaricensis', u'Podocarpus humbertii', u'Podocarpus henkelii', u'Podocarpus grayae', u'Podocarpus gnidioides', u'Podocarpus globulus', u'Podocarpus gibbsii', u'Podocarpus fasciculus', u'Podocarpus elongatus', u'Podocarpus elatus', u'Podocarpus lophatus', u'Podocarpus longifolius', u'Podocarpus longifoliolatus', u'Podocarpus levis', u'Podocarpus laubenfelsii', u'Podocarpus latifolius', u'Podocarpus insularis', u'Podocarpus madagascariensis', u'Podocarpus matudae', u'Podocarpus macrophyllus', u'Podocarpus neriifolius', u'Podocarpus novae-caledoniae', u'Podocarpus nubigenus', u'Podocarpus magnifolius', u'Podocarpus micropedunculatus', u'Podocarpus pectinatus', u'Podocarpus monteverdeensis', u'Podocarpus milanjianus', u'Podocarpus nivalis', u'Podocarpus nakaii', u'Podocarpus pseudobracteatus', u'Podocarpus polystachyus', u'Podocarpus oleifolius', u'Podocarpus ridleyi', u'Podocarpus pallidus', u'Podocarpus palawanensis', u'Podocarpus pendulifolius', u'Podocarpus parlatorei', u'Podocarpus polyspermus', u'Podocarpus pilgeri', u'Podocarpus perrieri', u'Podocarpus salignus', u'Podocarpus sellowii', u'Podocarpus ramosii', u'Podocarpus purdieanus', u'Podocarpus roraimae', u'Podocarpus rotundatus', u'Podocarpus rostratus', u'Podocarpus spathoides', u'Podocarpus rusbyi', u'Podocarpus rumphii', u'Podocarpus rubens', u'Podocarpus salicifolius', u'Podocarpus subtropicalis', u'Podocarpus teysmannii', u'Podocarpus totara', u'Podocarpus salomoniensis', u'Podocarpus smithii', u'Podocarpus spinulosus', u'Podocarpus urbanii', u'Podocarpus trinitensis', u'Podocarpus steyermarkii', u'Podocarpus sprucei', u'Podocarpus sylvestris', u'Podocarpus tepuiensis', u'Podocarpus transiens', u'Podocarpus woltzii', u'Podocarpus zamiifolius', u'Podocarpus macrocarpus', u'Podocarpus lucienii', u'Podocarpus \xd7 loderi', u'Podocarpus ledermannii', u'Podocarpus lawrencei', u'Podocarpus lambertii', u'Podocarpus indonesiensis', u'Podocarpus idioblastus', u'Podocarpus hispaniolensis', u'Podocarpus guatemalensis', u'Podocarpus glomeratus', u'Podocarpus glaucus', u'Podocarpus epiphyticus', u'Podocarpus deflexus', u'Podocarpus crassigemmis', u'Podocarpus costalis', u'Podocarpus corralensis', u'Podocarpus coriaceus', u'Podocarpus chingianus', u'Podocarpus capuronii', u'Podocarpus brasiliensis', u'Podocarpus aristulatus', u'Podocarpus annamiensis', u'Podocarpus alpinus', u'Retrophyllum rospigliosii', u'Phyllocladus toatoa', u'Podocarpus affinis', u'Podocarpus acuminatus', u'Phyllocladus aspleniifolius', u'Saxegothaea conspicua', u'Tsuga chinensis', u'Tsuga caroliniana', u'Pseudotsuga macrocarpa', u'Tsuga diversifolia', u'Strobus griffithii', u'Nageia arabica', u'Parasitaxus ustus', u'Pseudolarix amabilis', u'Pherosphaera hookeriana', u'Pherosphaera fitzgeraldii', u'Margbensonia thevetiiflia', u'Margbensonia chinense', u'Microcachrys tetragona', u'Nageia maxima', u'Pseudotsuga japonica', u'Nageia nagi', u'Nageia motleyi', u'Nageia palembanica', u'Pinus \xd7 attenuradiata', u'Pinus \xd7 ascendens', u'Pinus armandii', u'Pinus aristata', u'Pinus araucana', u'Pinus anemophila', u'Nageia wallichiana', u'Pinus amamiana', u'Pinus alepensis', u'Tsuga thuja', u'Tsuga mertensiana', u'Nageia formosensis', u'Pinus caribaea', u'Pinus canariensis', u'Pinus cembra', u'Pinus bungeana', u'Pinus brutia', u'Pinus benthamii', u'Pinus balfouriana', u'Pinus contorta', u'Pinus \xd7 cerambycifera', u'Pinus cembroides', u'Pinus densata', u'Pinus culminicola', u'Pinus \xd7 celakovskiorum', u'Pinus \xd7 digenea', u'Pinus densithunbergii', u'Pinus coulteri', u'Pinus dalatensis', u'Pinus echinata', u'Pinus dioica', u'Pinus clausa', u'Pinus elliottii', u'Pinus edulis', u'Pinus \xd7 densithunbergii', u'Pinus densiflora', u'Pinus \xd7 funebris', u'Pinus fragilissima', u'Pinus flexilis', u'Pinus fertilis', u'Pinus fenzeliana', u'Pinus devoniana', u'Pinus ghiesbrechtii', u'Pinus gerardiana', u'Pinus \xd7 hayatana', u'Pinus hartwegii', u'Pinus \xd7 halepensipinaster', u'Pinus \xd7 hakkodensis', u'Pinus hakkodensis', u'Pinus jaliscana', u'Pinus \xd7 holfordiana', u'Pinus \xd7 hunnewellii', u'Pinus herrerae', u'Pinus henryi', u'Pinus heeri', u'Pinus latteri', u'Pinus lambertiana', u'Pinus kwangshanensis', u'Pinus krempfii', u'Pinus koraiensis', u'Pinus maximinoi', u'Pinus maximartinezii', u'Pinus luzmariae', u'Pinus longaeva', u'Pinus \xd7 litvinovii', u'Pinus nelsonii', u'Pinus \xd7 naxiorum', u'Pinus muricata', u'Pinus morrisonicola', u'Pinus \xd7 parapumila', u'Pinus palustris', u'Pinus pallasiana', u'Pinus orthophylla', u'Pinus oocarpa', u'Pinus pinea', u'Pinus ponderosa', u'Pinus pinaster', u'Pinus patula', u'Pinus parviflora', u'Pinus pseudotaeda', u'Pinus pseudostrobus', u'Pinus quadrifolia', u'Pinus pumila', u'Pinus pringlei', u'Pinus reginae-ameliae', u'Pinus \xd7 rhaetica', u'Pinus resinosa', u'Pinus radiata', u'Pinus pinceana', u'Pinus praetermissa', u'Pinus rzedowskii', u'Pinus romaniae', u'Pinus sibirica', u'Pinus \xd7 sondereggeri', u'Pinus sebirica', u'Pinus sabiniana', u'Pinus pungens', u'Pinus remota', u'Pinus rigida', u'Pinus \xd7 spuria', u'Pinus sylvestris', u'Pinus subpatula', u'Pinus strobus', u'Pinus rigitaeda', u'Pinus \xd7 rigitaeda', u'Pinus roxburghii', u'Pinus serotina', u'Pinus strobiformis', u'Pinus squamata', u'Pinus torreyana', u'Pinus xichangensis', u'Pinus \xd7 wettsteinii', u'Pinus wangii', u'Pinus wallichiana', u'Pinus vindelica', u'Pinus uncinata', u'Pinus thunbergii', u'Pinus tecunumanii', u'Pinus taeda', u'Pinus tabuliformis', u'Pinus tropicalis', u'Pinus yunnanensis', u'Pinus virginiana', u'Pinus teocote', u'Pinus taiwanensis', u'Pinus stylesii', u'Pinus quinquefolia', u'Pinus peuce', u'Pinus occidentalis', u'Pinus nigra', u'Pinus \xd7 neilreichiana', u'Pinus \xd7 murraybanksiana', u'Pinus mugo', u'Pinus monticola', u'Pinus montezumae', u'Pinus monophylla', u'Pinus merkusii', u'Pinus massoniana', u'Pinus lumholtzii', u'Pinus luchuensis', u'Pinus leiophylla', u'Pinus lawsonii', u'Pinus kesiya', u'Pinus jeffreyi', u'Pinus hwangshanensis', u'Pinus heldreichii', u'Pinus halepensis', u'Pinus greggii', u'Pinus glabra', u'Pinus ghiesbreghtii', u'Pinus georginae', u'Pinus \xd7 galaiana', u'Pinus eremitana', u'Pinus engelmannii', u'Pinus durangensis', u'Pinus douglasiana', u'Pinus dahurica', u'Pinus cubensis', u'Pinus bhutanica', u'Pinus banksiana', u'Pinus ayacahuite', u'Pinus attenuata', u'Pinus arizonica', u'Pinus albicaulis', u'Tsuga sieboldii', u'Tsuga jeffreyi', u'Nageia fleuryi', u'Tsuga \xd7 jeffreyi', u'Tsuga heterophylla', u'Tsuga forrestii', u'Pseudotsuga sinensis', u'Tsuga dumosa', u'Pseudotsuga menziesii', u'Tsuga canadensis', u'Larix \xd7 eurokurilensis', u'Larix \xd7 czekanowskii', u'Larix czekanowskii', u'Larix \xd7 eurolepis', u'Picea alcoquiana', u'Keteleeria davidiana', u'Picea alcockiana', u'Picea \xd7 albertiana', u'Manoao colensoi', u'Hesperopeuce longibracteata', u'Larix gmelinii', u'Larix \xd7 hybrida', u'Larix \xd7 hians', u'Picea brachytyla', u'Picea breweriana', u'Dacrydium comosum', u'Dacrydium beccarii', u'Dacrydium araucarioides', u'Falcatifolium sleumeri', u'Falcatifolium gruezoi', u'Halocarpus kirkii', u'Halocarpus biformis', u'Keteleeria jezoensis', u'Keteleeria fortunei', u'Falcatifolium falcatum', u'Halocarpus bidwillii', u'Lepidothamnus laxifolius', u'Nothotsuga longibracteata', u'Larix decidua', u'Picea chihuahuana', u'Larix lyallii', u'Larix laricina', u'Larix maritima', u'Larix \xd7 maritima', u'Picea glauca', u'Picea fennica', u'Dacrydium lycopodioides', u'Dacrydium leptophyllum', u'Dacrydium huonense', u'Dacrydium guillauminii', u'Picea engelmannii', u'Picea crassifolia', u'Dacrydium ericoides', u'Dacrydium cornwallianum', u'Larix griffithii', u'Picea asperata', u'Picea austropanlanica', u'Larix koreensis', u'Larix kaempferi', u'Larix \xd7 lubarskii', u'Picea farreri', u'Picea koraiensis', u'Larix \xd7 polonica', u'Larix pendula', u'Picea koyamae', u'Larix stenophylla', u'Larix potaninii', u'Picea lutescends', u'Picea \xd7 mariorika', u'Picea \xd7 lutzii', u'Picea morrisonicola', u'Picea meyeri', u'Dacrydium spathoides', u'Dacrydium novoguineense', u'Picea linzhienensis', u'Dacrydium nausoriense', u'Dacrydium medium', u'Dacrydium mayi', u'Dacrydium magnum', u'Picea jezoensis', u'Larix occidentalis', u'Larix mastersiana', u'Larix \xd7 marschlinsii', u'Larix \xd7 pendula', u'Larix sibirica', u'Picea mariana', u'Dacrydium pectinatum', u'Picea maximowiczii', u'Dacrydium tenuifolium', u'Picea \xd7 notha', u'Picea neoveitchii', u'Dacrydium xanthandrum', u'Picea omorika', u'Picea obovata', u'Picea pungens', u'Picea retroflexa', u'Picea pungsanensis', u'Picea schrenkiana', u'Picea \xd7 saaghii', u'Picea shennongjianensis', u'Dacrydium vieillardii', u'Dacrydium thuioides', u'Dacrydium \xd7 suprinii', u'Picea \xd7 moseri', u'Picea orientalis', u'Picea purpurea', u'Picea rubens', u'Picea smithiana', u'Picea sitchensis', u'Picea shirasawae', u'Picea wilsonii', u'Picea spinulosa', u'Picea torano', u'Dacrydium nidulum', u'Picea likiangensis', u'Dacrydium mayi', u'Picea glehnii', u'Picea \xd7 fennica', u'Dacrydium gracile', u'Dacrydium gibbsiae', u'Dacrydium elatum', u'Dacrydium cupressinum', u'Falcatifolium taxoides', u'Picea aurantiaca', u'Dacrydium balansae', u'Falcatifolium papuanum', u'Falcatifolium falciforme', u'Lagarostrobos franklinii', u'Keteleeria evelyniana', u'Falcatifolium angustum', u'Lepidothamnus intermedius', u'Picea abies', u'Lepidothamnus fonkii', u'Abies alba', u'Abies amabilis', u'Acmopyle sahniana', u'Dacrycarpus dacrydioides', u'Dacrycarpus compactus', u'Dacrycarpus cinctus', u'Dacrycarpus expansus', u'Abies nebrodensis', u'Ephedra gerardiana', u'Abies numidica', u'Abies mariesii', u'Abies procera', u'Ephedra lomatolepis', u'Abies recurvata', u'Abies \xd7 shastensis', u'Abies \xd7 speciosa', u'Abies shensiensis', u'Abies sumatrana', u'Abies theisha', u'Abies yuanbaoshanensis', u'Ephedra rituensis', u'Abies sibirica', u'Abies ziyuanensis', u'Ephedra somalensis', u'Ephedra torreyana', u'Ephedra tilhoana', u'Ephedra trifurcata', u'Ephedra trifurcata', u'Ephedra tweedieana', u'Ephedra triandra', u'Ephedra strobilacea', u'Ephedra sarcocarpa', u'Ephedra sinica', u'Ephedra transitoria', u'Ephedra vvedenskyi', u'Ephedra viridis', u'Ephedra trifurca', u'Ephedra sumlingensis', u'Ephedra rupestris', u'Abies \xd7 vilmorinii', u'Ephedra rhytidosperma', u'Ephedra regeliana', u'Abies veitchii', u'Abies \xd7 vasconcellosiana', u'Ephedra pentandra', u'Ephedra pseudodistachya', u'Ephedra przewalskii', u'Abies vejarii', u'Ephedra pedunculata', u'Ephedra pachyclada', u'Ephedra oxyphylla', u'Abies spectabilis', u'Abies squamata', u'Ephedra ochreata', u'Ephedra nevadensis', u'Ephedra multiflora', u'Abies shensiensis', u'Ephedra monosperma', u'Ephedra minuta', u'Abies sachalinensis', u'Abies religiosa', u'Ephedra major', u'Ephedra likiangensis', u'Ephedra laristanica', u'Abies pinsapo', u'Ephedra milleri', u'Abies pindrow', u'Abies pendula', u'Ephedra khurikensis', u'Ephedra kardangensis', u'Ephedra \xd7 intermixta', u'Abies nordmanniana', u'Abies nephrolepis', u'Abies fabri', u'Ephedra intermedia', u'Ephedra holoptera', u'Ephedra glauca', u'Ephedra gerardiana', u'Ephedra funerea', u'Abies magnifica', u'Ephedra frustillata', u'Ephedra fragilis', u'Ephedra foliata', u'Ephedra foeminea', u'Abies lasiocarpa', u'Ephedra fedtschenkoae', u'Ephedra fasciculata', u'Ephedra equisetina', u'Abies koreana', u'Abies kawakamii', u'Abies \xd7 insignis', u'Ephedra \xd7 eleutherolepis', u'Abies homolepis', u'Abies holophylla', u'Abies hidalgensis', u'Ephedra dawuensis', u'Ephedra dahurica', u'Ephedra distachya', u'Abies hickelii', u'Abies guatemalensis', u'Abies grandis', u'Ephedra cutleri', u'Ephedra coryi', u'Abies fraseri', u'Abies forrestii', u'Abies firma', u'Ephedra compacta', u'Ephedra chilensis', u'Ephedra californica', u'Abies fargesii', u'Abies fanjingshanensis', u'Ephedra brevifoliata', u'Ephedra breana', u'Ephedra botschantzevii', u'Abies durangensis', u'Abies densa', u'Abies delavayi', u'Ephedra boelckei', u'Ephedra aurantiaca', u'Ephedra aspera', u'Dacrycarpus vieillardii', u'Abies concolor', u'Abies cilicica', u'Abies chensiensis', u'Ephedra \xd7 arenicola', u'Ephedra aphylla', u'Dacrycarpus steupii', u'Dacrycarpus kinabaluensis', u'Dacrycarpus imbricatus', u'Abies cephalonica', u'Abies bracteata', u'Ephedra antisyphilitica', u'Ephedra americana', u'Dacrycarpus cumingii', u'Abies \xd7 borisii-regis', u'Abies beshanzuensis', u'Abies balsamea', u'Ephedra altissima', u'Ephedra alata', u'Sciadopitys verticillata', u'Afrocarpus usambarensis', u'Afrocarpus mannii', u'Afrocarpus gracilior', u'Acmopyle pancheri', u'Afrocarpus falcatus', u'Afrocarpus dawei', u'Torreya californica', u'Pseudotaxus chienii', u'Taxus brevifolia', u'Encephalartos aemulans', u'Lepidozamia hopei', u'Macrozamia communis', u'Zamia beeldsnijderiana', u'Taxus fuana', u'Macrozamia cardiacensis', u'Microcycas calocoma', u'Zamia amplifolia', u'Zamia amazonum', u'Zamia acuminata', u'Taxus cuspidata', u'Taxus canadensis', u'Torreya parvifolia', u'Torreya jackii', u'Encephalartos cerinus', u'Zamia fischeri', u'Zamia fairchildiana', u'Encephalartos bubalinus', u'Encephalartos brevifoliolatus', u'Encephalartos barteri', u'Macrozamia dyeri', u'Macrozamia diplomera', u'Macrozamia crassifolia', u'Zamia dressleri', u'Zamia disodon', u'Zamia cunaria', u'Taxus sumatrana', u'Taxus sinensis', u'Encephalartos barteri', u'Encephalartos aplanatus', u'Macrozamia cranei', u'Macrozamia conferta', u'Zamia cremnophila', u'Zamia chigua', u'Zamia boliviana', u'Taxus \xd7 media', u'Encephalartos dolomiticus', u'Zamia herrerae', u'Encephalartos dolomiticus', u'Encephalartos cycadifolius', u'Encephalartos cupidus', u'Macrozamia johnsonii', u'Macrozamia heteromera', u'Macrozamia glaucophylla', u'Zamia gentryi', u'Zamia furfuracea', u'Zamia gomeziana', u'Encephalartos concinnus', u'Encephalartos cerinus', u'Macrozamia fraseri', u'Macrozamia flexuosa', u'Macrozamia fawcettii', u'Torreya grandis', u'Stangeria eriopus', u'Taxus baccata', u'Encephalartos gratus', u'Encephalartos graniticolus', u'Encephalartos ghellinckii', u'Encephalartos ferox', u'Macrozamia mountperriensis', u'Macrozamia moorei', u'Macrozamia miquelii', u'Zamia lecointei', u'Zamia ipetiensis', u'Encephalartos equatorialis', u'Encephalartos dyerianus', u'Encephalartos eugene-maraisii', u'Macrozamia longispina', u'Zamia imperialis', u'Lepidozamia peroffskyana', u'Encephalartos ituriensis', u'Zamia nesophila', u'Encephalartos humilis', u'Encephalartos horridus', u'Macrozamia reducta', u'Zamia muricata', u'Zamia monticola', u'Zamia melanorrhachis', u'Encephalartos hirsutus', u'Encephalartos hildebrandtii', u'Macrozamia plurinervia', u'Macrozamia pauli-guilielmi', u'Macrozamia parcifolia', u'Zamia manicata', u'Zamia macrochiera', u'Zamia purpurea', u'Zamia pumila', u'Zamia pseudomonticola', u'Encephalartos lebomboensis', u'Encephalartos latifrons', u'Zamia prasina', u'Zamia paucijuga', u'Zamia oreillyi', u'Encephalartos laevifolius', u'Encephalartos kisambo', u'Macrozamia viridis', u'Macrozamia spiralis', u'Macrozamia serpentina', u'Zamia obliqua', u'Encephalartos poggei', u'Zamia spartea', u'Encephalartos poggei', u'Encephalartos nubimontanus', u'Zamia soconuscensis', u'Zamia skinneri', u'Zamia roezlii', u'Encephalartos munchii', u'Encephalartos msinganus', u'Encephalartos marunguensis', u'Zamia pyrophylla', u'Zamia pygmaea', u'Encephalartos macrostrobilus', u'Encephalartos turneri', u'Encephalartos trispinosus', u'Encephalartos transvenosus', u'Encephalartos tegulaneus', u'Encephalartos septentrionalis', u'Encephalartos senticosus', u'Zamia wallisii', u'Zamia vazquezii', u'Encephalartos sclavoi', u'Encephalartos schmitzii', u'Encephalartos schaijesii', u'Zamia variegata', u'Zamia ulei', u'Zamia tuerckheimii', u'Encephalartos pterogonus', u'Encephalartos princeps', u'Zamia tridentata', u'Zamia tonkinensis', u'Encephalartos whitelockii', u'Encephalartos voiensis', u'Encephalartos villosus', u'Encephalartos umbeluziensis', u'Encephalartos woodii', u'Encephalartos turneri', u'Encephalartos septentrionalis', u'Zamia verschaffeltii', u'Encephalartos striatus', u'Encephalartos schmitzii', u'Zamia urep', u'Encephalartos relictus', u'Zamia standleyi', u'Encephalartos paucidentatus', u'Encephalartos ngoyanus', u'Zamia sandovalii', u'Encephalartos natalensis', u'Encephalartos middelburgensis', u'Zamia restrepoi', u'Zamia pygmaea', u'Encephalartos manikensis', u'Encephalartos mackenziei', u'Encephalartos longifolius', u'Zamia pseudoparasitica', u'Encephalartos lehmannii', u'Encephalartos laurentianus', u'Zamia poeppigiana', u'Encephalartos lanatus', u'Encephalartos kanga', u'Macrozamia stenomera', u'Macrozamia secunda', u'Zamia onan-reyesii', u'Zamia neurophyllidia', u'Encephalartos inopinus', u'Macrozamia riedlei', u'Macrozamia polymorpha', u'Zamia montana', u'Encephalartos heenanii', u'Macrozamia platyrhachis', u'Zamia meermanii', u'Zamia loddigesii', u'Encephalartos friderici-guilielmi', u'Macrozamia occidua', u'Macrozamia montana', u'Zamia lacandona', u'Zamia inermis', u'Macrozamia lucida', u'Macrozamia macdonnellii', u'Zamia incognita', u'Zamia hymenophyllidia', u'Encephalartos delucanus', u'Macrozamia lomandroides', u'Macrozamia humilis', u'Zamia hamannii', u'Encephalartos chimanimaniensis', u'Macrozamia fearnsidei', u'Zamia floridana', u'Zamia fischeri', u'Encephalartos caffer', u'Macrozamia elegans', u'Macrozamia douglasii', u'Zamia encephalartoides', u'Zamia decumbens', u'Taxus wallichiana', u'Encephalartos arenarius', u'Encephalartos altensteinii', u'Macrozamia concinna', u'Zamia bussellii', u'Taxus \xd7 hunnewelliana', u'Taxus globosa', u'Zamia angustifolia', u'Zamia amblyphyllidia', u'Taxus floridana', u'Torreya taxifolia', u'Torreya nucifera', u'Amentotaxus argotaenia', u'Cephalotaxus fortunei', u'Welwitschia mirabilis', u'Amentotaxus poilanei', u'Amentotaxus hatuyenensis', u'Cephalotaxus lanceolata', u'Cephalotaxus hainanensis', u'Cephalotaxus filiformis', u'Ceratozamia mexicana', u'Dioon spinulosum', u'Ceratozamia kuesteriana', u'Ceratozamia latifolia', u'Ceratozamia huastecorum', u'Dioon sonorense', u'Dioon purpusii', u'Ceratozamia hildae', u'Ceratozamia fusca-viridis', u'Dioon pectinatum', u'Dioon merolae', u'Dioon mejiae', u'Bowenia spectabilis', u'Ceratozamia decumbens', u'Ceratozamia becerrae', u'Dioon edule', u'Dioon califanoi', u'Cephalotaxus sinensis', u'Amentotaxus formosana', u'Amentotaxus assamica', u'Austrotaxus spicata', u'Ceratozamia sabatoi', u'Ceratozamia robusta', u'Ceratozamia norstogii', u'Ceratozamia mixeorum', u'Ceratozamia mirandae', u'Ceratozamia microstrobila', u'Dioon tomasellii', u'Dioon tellezii', u'Ceratozamia alvarezii', u'Dioon argenteum', u'Ceratozamia zoquorum', u'Ceratozamia whitelockiana', u'Ceratozamia whitelockiana', u'Ceratozamia santillanii', u'Ceratozamia zaragozae', u'Ceratozamia vovidesii', u'Ceratozamia morettii', u'Ceratozamia miqueliana', u'Dioon stevensonii', u'Ceratozamia matudae', u'Dioon spinulosum', u'Dioon rzedowskii', u'Ceratozamia hondurensis', u'Ceratozamia euryphyllidia', u'Dioon holmgrenii', u'Bowenia serrulata', u'Ceratozamia chimalapensis', u'Dioon caputoi', u'Cephalotaxus oliveri', u'Cephalotaxus mannii', u'Amentotaxus yunnanensis', u'Cephalotaxus latifolia', u'Cephalotaxus harringtonii', u'Ginkgo parvifolia', u'Ginkgo biloba', u'Gnetum camporum', u'Gnetum buchholzianum', u'Gnetum arboreum', u'Gnetum africanum', u'Gnetum cuspidatum', u'Gnetum costatum', u'Gnetum colombianum', u'Gnetum cleistostachyum', u'Gnetum cavaleriei', u'Gnetum catasphaericum', u'Gnetum karstenianum', u'Gnetum gracilipes', u'Gnetum gnemonoides', u'Gnetum giganteum', u'Gnetum formosum', u'Abutua africana', u'Gnetum leptostachyum', u'Gnetum microcarpum', u'Gnetum luofuense', u'Gnetum oblongum', u'Gnetum neglectum', u'Gnetum montanum', u'Gnetum pseudopaniculatum', u'Gnetum parvifolium', u'Gnetum scandens', u'Gnetum ridleyi', u'Gnetum raya', u'Gnetum ula', u'Gnetum trinerve', u'Gnetum schwackeanum', u'Gnetum paniculatum', u'Gnetum oxycarpum', u'Gnetum leyboldii', u'Gnetum latifolium', u'Gnetum klossii', u'Gnetum macrostachyum', u'Gnetum nodiflorum', u'Gnetum pendulum', u'Gnetum schwackeanum', u'Gnetum tenuifolium', u'Gnetum venuosum', u'Gnetum venosum', u'Gnetum urens', u'Gnetum loerzingii', u'Gnetum hainanense', u'Gnetum gnemon', u'Gnetum globosum', u'Gnetum diminutum', u'Gnetum contractum', u'Gnetum bosavicum', u'Gnetum acutum', u'Cycas duivenbodei', u'Cycas collina', u'Cycas clivicola', u'Cycas circinalis', u'Cycas chevalieri', u'Cycas curranii', u'Cycas cupida', u'Cycas crassipes', u'Cycas dolichophylla', u'Cycas diannanensis', u'Cycas debaoensis', u'Cycas falcata', u'Cycas elongata', u'Cycas elephantipes', u'Cycas edentata', u'Cycas glauca', u'Cycas furfuracea', u'Cycas fugax', u'Cycas ferruginea', u'Cycas hypoleuca', u'Cycas hongheensis', u'Cycas hongheensis', u'Cycas hoabinhensis', u'Cycas lacrimans', u'Cycas javana', u'Cycas inermis', u'Cycas indica', u'Cycas lanepoolei', u'Cycas media', u'Cycas macrocarpa', u'Cycas maconochiei', u'Cycas \xd7 longipetiolula', u'Cycas condaoensis', u'Cycas lingshuigensis', u'Cycas lindstromii', u'Cycas \xd7 multifrondis', u'Cycas montana', u'Cycas micronesica', u'Cycas micholitzii', u'Cycas nitida', u'Cycas nongnoochiae', u'Cycas nathorstii', u'Cycas multipinnata', u'Cycas saxatilis', u'Cycas segmentifida', u'Cycas seemannii', u'Cycas scratchleyana', u'Cycas schumanniana', u'Cycas rumphii', u'Cycas riuminiana', u'Cycas revoluta', u'Cycas sundaica', u'Cycas tanqingii', u'Cycas taiwaniana', u'Cycas taitungensis', u'Cycas szechuanensis', u'Cycas tropophylla', u'Cycas thouarsii', u'Cycas thouarsii', u'Cycas tansachana', u'Cycas zambalensis', u'Cycas wadei', u'Cycas vespertilio', u'Cycas swamyi', u'Cycas zeylanica', u'Cycas sphaerica', u'Cycas simplicipinna', u'Cycas silvestris', u'Cycas siamensis', u'Cycas shanyaensis', u'Cycas sexseminifera', u'Cycas pruinosa', u'Cycas pruinosa', u'Cycas pranburiensis', u'Cycas petrae', u'Cycas pectinata', u'Cycas papuana', u'Cycas pandanifolia', u'Cycas pachypoda', u'Cycas normanbyana', u'Cycas changjiangensis', u'Cycas chamaoensis', u'Cycas cantafolia', u'Cycas candida', u'Cycas campestris', u'Cycas calcicola', u'Cycas calcicola', u'Cycas cairnsiana', u'Cycas brachycantha', u'Cycas bougainvilleana', u'Cycas bifida', u'Cycas beddomei', u'Cycas balansae', u'Cycas armstrongii', u'Cycas apoa', u'Cycas annaikalensis', u'Cycas angulata', u'Cycas aenigma', u'Cycas aculeata', u'Athrotaxis selaginoides', u'Actinostrobus arenarius', u'Athrotaxis \xd7 laxifolia', u'Austrocedrus chilensis', u'Actinostrobus pyramidalis', u'Actinostrobus acuminatus', u'Thujopsis latifolia', u'Thujopsis dolabrata', u'Widdringtonia schwarzii', u'Thujopsis tschugatskoi', u'Widdringtonia nodiflora', u'Widdringtonia whytei', u'Widdringtonia wallichii', u'Athrotaxis cupressoides', u'\xd7 Taxodiomeria peizhongii', u'Taxodium huegelii', u'Tetraclinis articulata', u'Thuja beverleyensis', u'Thuja aphylla', u'Thuja \xd7 plicatoides', u'Thuja occidentalis', u'Thuja koraiensis', u'Thuja standishii', u'Thuja sutchuenensis', u'Thuja plicata', u'Thuja cristata', u'Taiwania cryptomerioides', u'Taxodium distichum', u'Sabina zaidamensis', u'Sabina wallichiana', u'Sabina lemeeana', u'Platycladus orientalis', u'Retinispora japonica', u'Retinispora glauca', u'Sabina jarkendensis', u'Sabina bonatiana', u'Sequoiadendron giganteum', u'Sequoia sempervirens', u'Microbiota decussata', u'Neocupropsis \xd7 ovensii', u'Neocupropsis \xd7 notabilis', u'Papuacedrus papuana', u'Pilgerodendron uviferum', u'Neocallitropsis pancheri', u'Neocupropsis \xd7 leylandii', u'Metasequoia disticha', u'Fokienia hodginsii', u'Juniperus \xd7 ambigens', u'Libocedrus austrocaledonica', u'Juniperus brevifolia', u'Juniperus bregeonii', u'Juniperus blancoi', u'Juniperus barbadensis', u'Juniperus australis', u'Juniperus ashei', u'Juniperus arizonica', u'Libocedrus yateensis', u'Libocedrus chevalieri', u'Juniperus communis', u'Juniperus comitana', u'Juniperus coahuilensis', u'Juniperus chinensis', u'Juniperus californica', u'Glyptostrobus pensilis', u'Libocedrus austrocaledonicus', u'Wollemia nobilis', u'Juniperus flaccida', u'Juniperus \xd7 fassettii', u'Juniperus fargessi', u'Juniperus erectopatens', u'Juniperus drupacea', u'Juniperus deppeana', u'Juniperus deltoides', u'Juniperus coxii', u'Juniperus henryana', u'Juniperus hartwissiana', u'Juniperus komarovii', u'Juniperus jarkendensis', u'Juniperus morrisonicola', u'Juniperus mucronata', u'Juniperus \xd7 media', u'Juniperus martinezii', u'Juniperus indica', u'Juniperus horizontalis', u'Juniperus gracilior', u'Juniperus frachetiana', u'Juniperus formosana', u'Juniperus grandis', u'Juniperus macrocarpa', u'Juniperus monticola', u'Juniperus phoenicea', u'Juniperus saltillensis', u'Juniperus semiglobosa', u'Juniperus saltuaria', u'Juniperus recurva', u'Juniperus scopulorum', u'Juniperus procumbens', u'Juniperus polycarpos', u'Juniperus pingii', u'Juniperus \xd7 palanciana', u'Juniperus occidentalis', u'Juniperus navicularis', u'Juniperus \xd7 pfitzeriana', u'Juniperus pseudosabina', u'Juniperus sabina', u'Juniperus tibetica', u'Juniperus thurifera', u'Juniperus taxifolia', u'Juniperus \xd7 talassica', u'Juniperus virginiana', u'Juniperus viminalis', u'Juniperus taiwaniana', u'Juniperus squamata', u'Juniperus zanonii', u'Juniperus tsukusiensis', u'Juniperus standleyi', u'Juniperus saxicola', u'Juniperus rigida', u'Juniperus przewalskii', u'Juniperus procera', u'Juniperus poblana', u'Juniperus pinchotii', u'Juniperus osteosperma', u'Juniperus monosperma', u'Juniperus oxycedrus', u'Juniperus microsperma', u'Juniperus maritima', u'Juniperus jaliscana', u'Juniperus \xd7 herragudensis', u'Juniperus foetidissima', u'Juniperus fassettii', u'Juniperus excelsa', u'Juniperus durangensis', u'Juniperus convallium', u'Juniperus compacta', u'Juniperus cedrus', u'Juniperus bermudiana', u'Juniperus angosturana', u'Libocedrus plumosa', u'Libocedrus bidwillii', u'Metasequoia glyptostroboides', u'Eutacta compacta', u'Cupressus cashmeriana', u'Cupressus breviramis', u'Cupressus balfouriana', u'Cupressus bakeri', u'Cunninghamia konishii', u'Cupressus amoena', u'Agathis alba', u'Columbea brasiliensis', u'Callitropsis pygmaea', u'Calocedrus decurrens', u'Cupressus \xd7 hybrida', u'Callitris columellaris', u'Araucaria luxurians', u'Cupressus \xd7 hickelii', u'Cupressus goveniana', u'Cupressus gigantea', u'Calocedrus rupestris', u'Chamaecyparis forsteckiensis', u'Callitris canescens', u'Calocedrus macrolepis', u'Agathis lanceolata', u'Agathis labillardierei', u'Agathis kinabaluensis', u'Agathis hami', u'Araucaria hunsteinii', u'Araucaria heterophylla', u'Araucaria columnaris', u'Cupressus funebris', u'Cupressus ericoides', u'Chamaecyparis formosensis', u'Chamaecyparis flifera', u'Agathis borneensis', u'Araucaria biramulata', u'Araucaria bidwillii', u'Araucaria araucana', u'Cupressus dupreziana', u'Cupressus chengiana', u'Diselma archeri', u'Fitzroya cupressoides', u'Cunninghamia lanceolata', u'Cryptomeria japonica', u'Agathis atropurpurea', u'Araucaria angustifolia', u'Calocedrus formosana', u'Cupressus torulosa', u'Cupressus tonkinensis', u'Cupressus thuia', u'Cupressus sargentii', u'Callitris sulcata', u'Cupressus religiosa', u'Cupressus \xd7 ovensii', u'Cupressus \xd7 notabilis', u'Callitris sinensis', u'Callitris roei', u'Callitris preissii', u'Agathis spinulosa', u'Agathis silbae', u'Agathis philippinensis', u'Araucaria subulata', u'Cupressus nivea', u'Cupressus madeirensis', u'Cupressus macrocarpa', u'Callitris oblonga', u'Callitris muelleri', u'Agathis ovata', u'Agathis moorei', u'Agathis montana', u'Araucaria rulei', u'Cupressus lusitanica', u'Cupressus \xd7 loritiensis', u'Cupressus \xd7 leylandii', u'Callitris macleayana', u'Callitris endlicheri', u'Agathis microstachya', u'Agathis macrostrobila', u'Agathis lenticula', u'Araucaria muelleri', u'Cupressus ugelii', u'Cupressus vietnamensis', u'Cupressus torulosis', u'Cupressus torulosa', u'Cupressus sempervirens', u'Callitris verrucosa', u'Cupressus nootkatensis', u'Callitris rhomboidea', u'Agathis robusta', u'Araucaria scopulorum', u'Cupressus macnabiana', u'Callitris neocaledonica', u'Agathis orbicula', u'Araucaria schmidii', u'Araucaria nemorosa', u'Callitris monticola', u'Callitris drummondii', u'Chamaecyparis thyoides', u'Agathis macrophylla', u'Araucaria montana', u'Araucaria laubenfelsii', u'Cupressus guadalupensis', u'Callitris baileyi', u'Chamaecyparis lawsoniana', u'Chamaecyparis pisifera', u'Chamaecyparis obtusa', u'Agathis flavescens', u'Araucaria humboldtensis', u'Araucaria cunninghamii', u'Cupressus elegans', u'Agathis dammara', u'Agathis australis', u'Araucaria bernieri', u'Cupressus duclouxiana', u'Cupressus arizonica']
path = Path(__file__).parent

app = Starlette()
app.add_middleware(CORSMiddleware, allow_origins=['*'], allow_headers=['X-Requested-With', 'Content-Type'])
app.mount('/static', StaticFiles(directory='app/static'))


async def download_file(url, dest):
    if dest.exists(): return
    async with aiohttp.ClientSession() as session:
        async with session.get(url) as response:
            data = await response.read()
            with open(dest, 'wb') as f:
                f.write(data)


async def setup_learner():
    await download_file(export_file_url, path / export_file_name)
    try:
        learn = load_learner(path, export_file_name)
        return learn
    except RuntimeError as e:
        if len(e.args) > 0 and 'CPU-only machine' in e.args[0]:
            print(e)
            message = "\n\nThis model was trained with an old version of fastai and will not work in a CPU environment.\n\nPlease update the fastai library in your training environment and export your model again.\n\nSee instructions for 'Returning to work' at https://course.fast.ai."
            raise RuntimeError(message)
        else:
            raise


loop = asyncio.get_event_loop()
tasks = [asyncio.ensure_future(setup_learner())]
learn = loop.run_until_complete(asyncio.gather(*tasks))[0]
loop.close()


@app.route('/')
async def homepage(request):
    html_file = path / 'view' / 'index.html'
    return HTMLResponse(html_file.open().read())


@app.route('/analyze', methods=['POST'])
async def analyze(request):
    img_data = await request.form()
    img_bytes = await (img_data['file'].read())
    img = open_image(BytesIO(img_bytes))
    prediction = learn.predict(img)[0]
    return JSONResponse({'result': str(prediction)})


if __name__ == '__main__':
    if 'serve' in sys.argv:
        uvicorn.run(app=app, host='0.0.0.0', port=5000, log_level="info")
